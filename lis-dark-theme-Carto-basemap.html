<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" />

    <title>Carto Dark Theme</title>

    <!-- Latest Leaflet Style Sheet-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        body,
        #map {
            position: absolute;
            width: 100%;
            top: 0;
            bottom: 0;
            margin: 0;
            padding: 0;
            background: rgba(0, 0, 0, 0.8);
        }

        .transitCenters {
            text-align: center;
            line-height: 16px;
            color: black;
            font-size: 12px;
            background: #ccc;
            box-shadow: 0 0 1px #000;
            border-radius: 50%;
            height: 1em;
            width: 1em;
        }

        .transitCenters:hover {
            text-align: center;
            line-height: 16px;
            color: black;
            font-size: 12px;
            background: yellow;
            box-shadow: 0 0 1px #000;
            border-radius: 50%;
            height: 1em;
            width: 1em;
        }

    </style>
</head>

<body>
    <div id="map"></div>

    <!-- Latest Leaflet Source-->
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>

    <!-- Latest Jquery Source -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

    <script>
        const options = {
            center: [45.46, -122.684],
            zoom: 11,
            minZoom: 11
        };
        const map = L.map("map", options);

        const boundaryOptions = {
            color: "#ccc",
            weight: 0.5,
            opacity: 0.3,
            fillColor: "black",
            fillOpacity: 0.4
        };

        const streetcarOptions = {
            color: "#16a085",
            weight: 3,
            opacity: 1
        };
        const commuterRailOptions = {
            color: "#2980b9",
            weight: 3,
            opacity: 1
        };
        const railOptions = {
            color: "#e74c3c",
            weight: 3
        };
        const otherRoutes = {
            color: "#34499"
        };

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}' + (L.Browser.retina ? '@2x.png' : '.png'), {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20,
            minZoom: 0
        }).addTo(map);


        map.createPane("labels");
        map.getPane("labels").style.zIndex = 649;
        map.getPane("labels").style.pointerEvents = "none";

        L.tileLayer(
            "https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png", {
                attribution: "©OpenStreetMap, ©CartoDB",
                pane: "labels"
            }
        ).addTo(map);


        $.when(
            $.getJSON("data/boundary-inverse.json"),
            $.getJSON("data/rail-lines.json"),
            $.getJSON("data/rail-stops.json"),
            $.getJSON("data/transit-centers.json"),
        ).done(function(trimetBoundary, trimetRailLine, trimetRailStops, trimetTransitCenters) {
            drawMap(trimetBoundary, trimetRailLine, trimetRailStops, trimetTransitCenters);
        });

        function drawMap(
            trimetBoundaryData,
            trimetRailLineData,
            trimetRailStopsData,
            trimetTransitCentersData
        ) {
            // add trimet boundary layer
            L.geoJson(trimetBoundaryData, {
                style: boundaryOptions
            }).addTo(map);

            // add trimet rail line layer
            L.geoJson(trimetRailLineData, {
                // style each feature
                style: function(feature) {
                    // shortcut to variable
                    let type = feature.properties.type;
                    // assign options
                    return type === "Portland Streetcar" ?
                        streetcarOptions :
                        type === "WES Commuter Rail" ?
                        commuterRailOptions :
                        type === "MAX Light Rail" ?
                        railOptions :
                        otherRoutes;
                },
                onEachFeature: function(feature, layer) {
                    // shortut to variable
                    let tooltip = feature.properties.type;
                    // bind the tooltip to the layer
                    layer.bindTooltip(tooltip, {
                        sticky: true,
                        className: "tooltip"
                    });
                    // mouseover
                    layer.on('mouseover', function() {
                        layer.setStyle({
                            weight: 7
                        });
                    });
                    // mouseout
                    layer.on('mouseout', function() {
                        layer.setStyle({
                            weight: 3
                        });
                    });
                }
            }).addTo(map);

            // add trimet rail stops layer
            const railStops = L.geoJson(trimetRailStopsData, {
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        color: '#555',
                        weight: 1,
                        fillColor: '#ccc',
                        fillOpacity: 1,
                        radius: 2
                    });
                },
                onEachFeature: function(feature, layer) {
                    // shortut to variable
                    let tooltip = feature.properties.STATION;
                    // bind the tooltip to the layer
                    layer.bindTooltip(tooltip, {
                        sticky: true,
                        className: "tooltip"
                    });
                    // mouseover
                    layer.on('mouseover', function() {
                        layer.setStyle({
                            color: '#ccc',
                            weight: 2,
                            fillColor: '#333',
                            fillOpacity: 0.5,
                            radius: 8
                        });
                    });
                    // mouseout
                    layer.on('mouseout', function() {
                        layer.setStyle({
                            color: '#555',
                            weight: 1,
                            fillColor: '#ccc',
                            fillOpacity: 1,
                            radius: 2
                        });
                    });
                }
            });

            map.on('zoomend', onZoomend);

            function onZoomend() {
                if (map.getZoom() < 12) {
                    map.removeLayer(railStops);
                };
                if (map.getZoom() >= 12) {
                    map.addLayer(railStops);
                };
            };

            // add trimet transit centers layer
            L.geoJson(trimetTransitCentersData, {
                pointToLayer: function(feature, latlng) {
                    return L.marker(latlng, {
                        icon: L.divIcon({
                            html: '<i class="fa fa-bus"></i>',
                            iconSize: [16, 16],
                            className: 'transitCenters'
                        })
                    });
                },
                onEachFeature: function(feature, layer) {
                    // shortut to variable
                    let tooltip = feature.properties.name;
                    // bind the tooltip to the layer
                    layer.bindTooltip(tooltip, {
                        sticky: true,
                        className: "tooltip"
                    });
                }
            }).addTo(map);
        }

    </script>
</body>

</html>
